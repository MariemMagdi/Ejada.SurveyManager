@page "/survey-instances/create"
@using Volo.Abp.Application.Dtos
@using Ejada.SurveyManager.SurveyInstances
@using Ejada.SurveyManager.SurveyInstances.Dtos
@using Ejada.SurveyManager.Surveys
@using Ejada.SurveyManager.Surveys.Dtos
@using Ejada.SurveyManager.Localization
@using Volo.Abp.Identity
@inject NavigationManager NavigationManager
@inject ISurveyInstanceAppService SurveyInstanceService
@inject ISurveyAppService SurveyService
@inject IIdentityUserAppService UserService
@inject Volo.Abp.AspNetCore.Components.Web.AbpBlazorMessageLocalizerHelper<SurveyManagerResource> LH

@inherits AbpComponentBase

<div class="modern-page-wrapper">
    <div class="glass-card">
        <div class="gradient-header">
            <div class="gradient-header-content">
                <Row Class="align-items-center justify-content-between g-3">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex align-items-center">
                            <div class="header-icon-box me-3">
                                <Icon Name="IconName.UserPlus" Size="IconSize.ExtraLarge" />
                            </div>
                            <div>
                                <h2 class="mb-1 fw-bold text-white">@LH.Localize("AssignSurvey")</h2>
                                <p class="text-white-50 mb-0">@LH.Localize("AssignSurveyToEmployeeDescription")</p>
                            </div>
                        </div>
                    </Column>
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <Button Color="Color.Secondary" Outline Clicked="Back" Class="btn-light">
                            <Icon Name="IconName.ArrowLeft" />
                            @LH.Localize("Back")
                        </Button>
                    </Column>
                </Row>
            </div>
        </div>

        <div class="px-4 pb-4">
        <Form>
            <Validations @ref="@CreateValidationsRef"
                         Model="@NewEntity"
                         ValidateOnLoad="false">
                <div class="dashboard-card mb-4">
                    <div class="dashboard-card-header">
                        <h5 class="dashboard-card-title">
                            <Icon Name="IconName.InfoCircle" Class="text-primary me-2" />
                            @LH.Localize("AssignmentDetails")
                        </h5>
                    </div>
                    <div class="dashboard-card-body">
                        <Validation MessageLocalizer="@LH.Localize">
                            <Field>
                                <FieldLabel>@LH.Localize("Survey") *</FieldLabel>
                                <Select TValue="Guid" @bind-SelectedValue="NewEntity.SurveyId">
                                    <SelectItem Value="Guid.Empty">-- @LH.Localize("SelectSurvey") --</SelectItem>
                                    @foreach (var survey in Surveys)
                                    {
                                        <SelectItem Value="@survey.Id">@survey.Name</SelectItem>
                                    }
                                </Select>
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </Field>
                        </Validation>

                        <Validation MessageLocalizer="@LH.Localize">
                            <Field>
                                <FieldLabel>@LH.Localize("AssignToEmployee") *</FieldLabel>
                                <Select TValue="Guid" @bind-SelectedValue="NewEntity.AssigneeUserId">
                                    <SelectItem Value="Guid.Empty">-- @LH.Localize("SelectEmployee") --</SelectItem>
                                    @foreach (var user in Users)
                                    {
                                        <SelectItem Value="@user.Id">@user.UserName (@user.Email)</SelectItem>
                                    }
                                </Select>
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </Field>
                        </Validation>

                        <Field>
                            <FieldLabel>@LH.Localize("DueDate") <small class="text-muted">(@LH.Localize("Optional"))</small></FieldLabel>
                            <DateEdit TValue="DateTime?" @bind-Date="NewEntity.DueDate" />
                            <FieldHelp>@LH.Localize("LeaveEmptyForNoDueDate")</FieldHelp>
                        </Field>
                    </div>
                </div>
            </Validations>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <Button Color="Color.Primary" Outline Clicked="Back">
                    <Icon Name="IconName.Times" />
                    @LH.Localize("Cancel")
                </Button>

                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="CreateSurveyInstanceAsync"
                        Class="px-5 btn-modern">
                    <Icon Name="IconName.UserPlus" />
                    @LH.Localize("Assign")
                </Button>
            </div>
        </Form>
        </div>
    </div>
</div>

@code {
    private Validations? CreateValidationsRef;
    private CreateSurveyInstanceDto NewEntity { get; set; } = new();
    private List<SurveyDto> Surveys { get; set; } = new();
    private List<IdentityUserDto> Users { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSurveysAsync();
        await LoadUsersAsync();
    }

    private async Task LoadSurveysAsync()
    {
        var result = await SurveyService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
        Surveys = result.Items.Where(s => s.IsActive).ToList();
    }

    private async Task LoadUsersAsync()
    {
        var result = await UserService.GetListAsync(new GetIdentityUsersInput { MaxResultCount = 1000 });
        
        // Filter to only show users with "Employee" role
        var allUsers = result.Items.ToList();
        Users = new List<IdentityUserDto>();
        
        foreach (var user in allUsers)
        {
            var roles = await UserService.GetRolesAsync(user.Id);
            if (roles.Items.Any(r => r.Name == "Employee"))
            {
                Users.Add(user);
            }
        }
    }

    private async Task CreateSurveyInstanceAsync()
    {
        if (CreateValidationsRef != null && !await CreateValidationsRef.ValidateAll())
        {
            return;
        }

        if (NewEntity.SurveyId == Guid.Empty)
        {
            // Show error message
            return;
        }

        if (NewEntity.AssigneeUserId == Guid.Empty)
        {
            // Show error message
            return;
        }

        await SurveyInstanceService.CreateAsync(NewEntity);
        NavigationManager.NavigateTo("/survey-instances");
    }

    private void Back()
    {
        NavigationManager.NavigateTo("/survey-instances");
    }
}

