@page "/surveys/create"
@using System.Linq
@using System.Collections.Generic
@using Volo.Abp.Application.Dtos
@using Ejada.SurveyManager.Surveys.Dtos
@using Ejada.SurveyManager.Surveys
@using Ejada.SurveyManager.Surveys.Enums
@using Ejada.SurveyManager.Localization
@inject NavigationManager NavigationManager
@inject ISurveyAppService SurveyService
@inject IQuestionAppService QuestionService
@inject Volo.Abp.AspNetCore.Components.Web.AbpBlazorMessageLocalizerHelper<SurveyManagerResource> LH

@inherits AbpCrudPageBase<ISurveyAppService, SurveyDto, Guid, PagedAndSortedResultRequestDto, CreateSurveyDto, UpdateSurveyDto>

<div class="modern-page-wrapper">
    <div class="glass-card">
        <div class="gradient-header">
            <div class="gradient-header-content">
                <Row Class="align-items-center justify-content-between g-3">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex align-items-center">
                            <div class="header-icon-box me-3">
                                <Icon Name="IconName.Add" Size="IconSize.ExtraLarge" />
                            </div>
                            <div>
                                <h2 class="mb-1 fw-bold text-white">@LH.Localize("NewSurvey")</h2>
                                <p class="text-white-50 mb-0">@LH.Localize("CreateNewSurveyWithQuestions")</p>
                            </div>
                        </div>
                    </Column>
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <Button Color="Color.Secondary" Outline Clicked="Back" Class="btn-light">
                            <Icon Name="IconName.ArrowLeft" />
                            @LH.Localize("Back")
                        </Button>
                    </Column>
                </Row>
            </div>
        </div>

        <div class="px-4 pb-4">
        <Form>
            <Validations @ref="@CreateValidationsRef" Model="@NewEntity" ValidateOnLoad="false" @key="NewEntity">
                <!-- General Information Section -->
                <div class="dashboard-card mb-4">
                    <div class="dashboard-card-header">
                        <h5 class="dashboard-card-title">
                            <Icon Name="IconName.InfoCircle" Class="text-primary me-2" />
                            @LH.Localize("GeneralInformation")
                        </h5>
                    </div>
                    <div class="dashboard-card-body">
                        <Validation MessageLocalizer="@LH.Localize">
                            <Field>
                                <FieldLabel>@LH.Localize("Name") *</FieldLabel>
                                <TextEdit @bind-Text="@NewEntity.Name" Placeholder="@LH.Localize("EnterSurveyName")">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </TextEdit>
                            </Field>
                        </Validation>

                        <Field>
                            <FieldLabel>@LH.Localize("Purpose")</FieldLabel>
                            <MemoEdit @bind-Text="NewEntity.Purpose" Rows="3" Placeholder="@LH.Localize("EnterSurveyPurpose")" />
                        </Field>

                        <Field>
                            <FieldLabel>@LH.Localize("TargetAudience")</FieldLabel>
                            <TextEdit @bind-Text="NewEntity.TargetAudience" Placeholder="@LH.Localize("EnterTargetAudience")" />
                        </Field>

                        <Field>
                            <Check TValue="bool" @bind-Checked="NewEntity.IsActive">
                                @LH.Localize("Active")
                            </Check>
                            <FieldHelp>@LH.Localize("MakeSurveyAvailableForAssignment")</FieldHelp>
                        </Field>
                    </div>
                </div>

                <!-- Questions Section -->
                <div class="dashboard-card mb-4">
                    <div class="dashboard-card-header">
                        <h5 class="dashboard-card-title">
                            <Icon Name="IconName.QuestionCircle" Class="text-primary me-2" />
                            @LH.Localize("AttachedQuestions")
                        </h5>
                    </div>
                    <div class="dashboard-card-body">
                        @if (!AttachedQuestions.Any())
                        {
                            <Alert Color="Color.Info" Visible>
                                <Icon Name="IconName.InfoCircle" Class="me-2" />
                                @LH.Localize("NoQuestionsAttached")
                            </Alert>
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var q in AttachedQuestions)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" @key="q">
                                        <div class="d-flex align-items-center">
                                            <Icon Name="IconName.File" Class="text-info me-2" />
                                            <div>
                                                <strong>@q.Text</strong>
                                                <Badge Color="Color.Secondary" Class="ms-2">@q.Type</Badge>
                                            </div>
                                        </div>
                                        <Button Color="Color.Danger" Size="Size.Small" Outline Clicked="@(() => RemoveAttachedQuestion(q))">
                                            <Icon Name="IconName.Delete" />
                                            @LH.Localize("Remove")
                                        </Button>
                                    </div>
                                }
                            </div>
                        }

                        <hr class="my-4" />

                        @* Section 1: Select from Existing Questions *@
                        <Accordion>
                            <Collapse Visible="@ShowExistingQuestionsSection">
                                <CollapseHeader>
                                    <Heading Size="HeadingSize.Is5">
                                        <AccordionToggle Clicked="@(() => ShowExistingQuestionsSection = !ShowExistingQuestionsSection)">
                                            <Icon Name="IconName.List" /> @LH.Localize("SelectExistingQuestions")
                                        </AccordionToggle>
                                    </Heading>
                                </CollapseHeader>
                                <CollapseBody>
                                    <Field>
                                        <FieldLabel>@LH.Localize("AvailableQuestions")</FieldLabel>
                                        <Select TValue="Guid?" @bind-SelectedValue="SelectedQuestionId">
                                            <SelectItem Value="@((Guid?)null)">-- @LH.Localize("SelectQuestion") --</SelectItem>
                                            @foreach (var q in FilteredAvailableQuestions)
                                            {
                                                <SelectItem Value="@((Guid?)q.Id)">@q.Text</SelectItem>
                                            }
                                        </Select>
                                        <Button Color="Color.Success" Clicked="AddExistingQuestion" Class="mt-2">
                                            <Icon Name="IconName.Add" />
                                            @LH.Localize("AddQuestion")
                                        </Button>
                                    </Field>
                                </CollapseBody>
                            </Collapse>
                        </Accordion>

                        @* Section 2: Create New Question Inline *@
                        <Accordion>
                            <Collapse Visible="@ShowNewQuestionSection">
                                <CollapseHeader>
                                    <Heading Size="HeadingSize.Is5">
                                        <AccordionToggle Clicked="@(() => ShowNewQuestionSection = !ShowNewQuestionSection)">
                                            <Icon Name="IconName.Add" /> @LH.Localize("CreateNewQuestion")
                                        </AccordionToggle>
                                    </Heading>
                                </CollapseHeader>
                                <CollapseBody>
                                    <Field>
                                        <FieldLabel>@LH.Localize("QuestionText")</FieldLabel>
                                        <TextEdit @bind-Text="NewQuestionText" Placeholder="@LH.Localize("EnterQuestionText")" />
                                    </Field>
                                    <Field>
                                        <FieldLabel>@LH.Localize("QuestionType")</FieldLabel>
                                        <Select TValue="QuestionType" @bind-SelectedValue="NewQuestionType">
                                            @foreach (var type in QuestionTypes)
                                            {
                                                <SelectItem Value="@type">@type.ToString()</SelectItem>
                                            }
                                        </Select>
                                    </Field>

                                    @if (NewQuestionRequiresOptions)
                                    {
                                        <Field>
                                            <FieldLabel>@LH.Localize("Options")</FieldLabel>
                                            <div class="border rounded p-3 bg-light">
                                                @for (var i = 0; i < NewQuestionOptions.Count; i++)
                                                {
                                                    var idx = i;
                                                    var opt = NewQuestionOptions[i];
                                                    <Row class="align-items-end mb-2" @key="opt">
                                                        <Column>
                                                            @if (opt.Type == OptionDataType.String)
                                                            {
                                                                <TextEdit Text="@opt.Label" 
                                                                         TextChanged="@((string value) => OnNewQuestionOptionLabelChanged(opt, value))"
                                                                         Placeholder="@LH.Localize("OptionLabel")"
                                                                         Color="@(IsNewQuestionOptionLabelValid(opt) ? null : Color.Danger)" />
                                                                @if (!IsNewQuestionOptionLabelValid(opt) && !string.IsNullOrWhiteSpace(opt.Label))
                                                                {
                                                                    <small class="text-danger d-block mt-1">@GetNewQuestionOptionValidationMessage(opt)</small>
                                                                }
                                                            }
                                                            else if (opt.Type == OptionDataType.Int)
                                                            {
                                                                <TextEdit Text="@opt.Label"
                                                                          TextChanged="@((string value) => OnNewQuestionOptionLabelChanged(opt, value))"
                                                                          Type="TextInputType.Number"
                                                                          Placeholder="@LH.Localize("EnterWholeNumber")"
                                                                          Color="@(IsNewQuestionOptionLabelValid(opt) ? null : Color.Danger)" />
                                                                @if (!IsNewQuestionOptionLabelValid(opt) && !string.IsNullOrWhiteSpace(opt.Label))
                                                                {
                                                                    <small class="text-danger d-block mt-1">@GetNewQuestionOptionValidationMessage(opt)</small>
                                                                }
                                                            }
                                                            else if (opt.Type == OptionDataType.Decimal)
                                                            {
                                                                <TextEdit Text="@opt.Label"
                                                                          TextChanged="@((string value) => OnNewQuestionOptionLabelChanged(opt, value))"
                                                                          Type="TextInputType.Number"
                                                                          Step="0.01"
                                                                          Placeholder="@LH.Localize("EnterDecimalNumber")"
                                                                          Color="@(IsNewQuestionOptionLabelValid(opt) ? null : Color.Danger)" />
                                                                @if (!IsNewQuestionOptionLabelValid(opt) && !string.IsNullOrWhiteSpace(opt.Label))
                                                                {
                                                                    <small class="text-danger d-block mt-1">@GetNewQuestionOptionValidationMessage(opt)</small>
                                                                }
                                                            }
                                                            else if (opt.Type == OptionDataType.Bool)
                                                            {
                                                                <Select TValue="string" SelectedValue="@opt.Label"
                                                                        SelectedValueChanged="@((string value) => OnNewQuestionOptionLabelChanged(opt, value))"
                                                                        Color="@(IsNewQuestionOptionLabelValid(opt) ? null : Color.Danger)">
                                                                    <SelectItem Value="true">True</SelectItem>
                                                                    <SelectItem Value="false">False</SelectItem>
                                                                </Select>
                                                                @if (!IsNewQuestionOptionLabelValid(opt) && !string.IsNullOrWhiteSpace(opt.Label))
                                                                {
                                                                    <small class="text-danger d-block mt-1">@GetNewQuestionOptionValidationMessage(opt)</small>
                                                                }
                                                            }
                                                            else if (opt.Type == OptionDataType.Date)
                                                            {
                                                                <DateEdit TValue="DateTime?" 
                                                                          Date="@GetDateFromNewQuestionOption(opt)"
                                                                          DateChanged="@((DateTime? date) => { SetDateToNewQuestionOption(opt, date); OnNewQuestionOptionLabelChanged(opt, opt.Label); })"
                                                                          DisplayFormat="yyyy-MM-dd" />
                                                                @if (!IsNewQuestionOptionLabelValid(opt) && !string.IsNullOrWhiteSpace(opt.Label))
                                                                {
                                                                    <small class="text-danger d-block mt-1">@GetNewQuestionOptionValidationMessage(opt)</small>
                                                                }
                                                            }
                                                            else if (opt.Type == OptionDataType.DateTime)
                                                            {
                                                                <DateEdit TValue="DateTime?" 
                                                                          Date="@GetDateTimeFromNewQuestionOption(opt)"
                                                                          DateChanged="@((DateTime? date) => { SetDateTimeToNewQuestionOption(opt, date); OnNewQuestionOptionLabelChanged(opt, opt.Label); })"
                                                                          InputMode="DateInputMode.DateTime"
                                                                          DisplayFormat="yyyy-MM-dd HH:mm" />
                                                                @if (!IsNewQuestionOptionLabelValid(opt) && !string.IsNullOrWhiteSpace(opt.Label))
                                                                {
                                                                    <small class="text-danger d-block mt-1">@GetNewQuestionOptionValidationMessage(opt)</small>
                                                                }
                                                            }
                                                        </Column>
                                                        <Column ColumnSize="ColumnSize.IsAuto">
                                                            <Select TValue="OptionDataType" SelectedValue="@opt.Type"
                                                                    SelectedValueChanged="@((OptionDataType newType) => OnNewQuestionOptionTypeChanged(opt, newType))">
                                                                @foreach (var dataType in OptionDataTypes)
                                                                {
                                                                    <SelectItem Value="@dataType">@dataType.ToString()</SelectItem>
                                                                }
                                                            </Select>
                                                        </Column>
                                                        <Column ColumnSize="ColumnSize.IsAuto">
                                                            <Button Color="Color.Danger" Size="Size.Small" Outline Clicked="@(() => RemoveNewQuestionOption(idx))">
                                                                <Icon Name="IconName.Delete" />
                                                            </Button>
                                                        </Column>
                                                    </Row>
                                                }
                                                <Button Color="Color.Secondary" Outline Clicked="AddNewQuestionOption">
                                                    <Icon Name="IconName.Add" />
                                                    @LH.Localize("AddOption")
                                                </Button>
                                            </div>
                                        </Field>
                                    }

                                    <Button Color="Color.Primary" Clicked="AddNewQuestion" Class="mt-2">
                                        <Icon Name="IconName.Add" />
                                        @LH.Localize("AddNewQuestionToSurvey")
                                    </Button>
                                </CollapseBody>
                            </Collapse>
                        </Accordion>
                    </div>
                </div>
            </Validations>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <Button Color="Color.Primary" Outline Clicked="Back">
                    <Icon Name="IconName.Times" />
                    @LH.Localize("Cancel")
                </Button>

                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="SaveSurveyAsync"
                        Class="px-5 btn-modern">
                    <Icon Name="IconName.Save" />
                    @LH.Localize("Save")
                </Button>
            </div>
        </Form>
        </div>
    </div>
</div>

@code {
    private List<QuestionDto> AvailableQuestions { get; set; } = new();
    private Guid? SelectedQuestionId { get; set; }
    
    // Collapse states
    private bool ShowExistingQuestionsSection { get; set; } = false;
    private bool ShowNewQuestionSection { get; set; } = false;
    
    // New question inline
    private string NewQuestionText { get; set; } = string.Empty;
    private QuestionType NewQuestionType { get; set; } = QuestionType.SingleChoice;
    private List<CreateOptionInQuestionDto> NewQuestionOptions { get; set; } = new() { new CreateOptionInQuestionDto() };
    
    // Attached questions display
    private class AttachedQuestionItem
    {
        public string Text { get; set; } = string.Empty;
        public QuestionType Type { get; set; }
        public Guid? ExistingQuestionId { get; set; }
        public CreateQuestionInSurveyDto? NewQuestionDto { get; set; }
    }
    private List<AttachedQuestionItem> AttachedQuestions { get; set; } = new();

    private static IEnumerable<QuestionType> QuestionTypes => Enum.GetValues<QuestionType>();
    private static IEnumerable<OptionDataType> OptionDataTypes => Enum.GetValues<OptionDataType>();

    private bool NewQuestionRequiresOptions => 
        NewQuestionType == QuestionType.SingleChoice || NewQuestionType == QuestionType.MultiChoice;

    // Filter out questions that are already attached
    private IEnumerable<QuestionDto> FilteredAvailableQuestions
    {
        get
        {
            var attachedQuestionIds = AttachedQuestions
                .Where(q => q.ExistingQuestionId.HasValue)
                .Select(q => q.ExistingQuestionId.Value)
                .ToHashSet();
            
            return AvailableQuestions.Where(q => !attachedQuestionIds.Contains(q.Id));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadAvailableQuestions();
    }

    private async Task LoadAvailableQuestions()
    {
        var result = await QuestionService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
        AvailableQuestions = result.Items.ToList();
    }

    private void AddExistingQuestion()
    {
        if (SelectedQuestionId == null) return;
        
        var question = AvailableQuestions.FirstOrDefault(q => q.Id == SelectedQuestionId.Value);
        if (question == null) return;
        
        if (AttachedQuestions.Any(q => q.ExistingQuestionId == question.Id)) return;
        
        AttachedQuestions.Add(new AttachedQuestionItem
        {
            Text = question.Text,
            Type = question.Type,
            ExistingQuestionId = question.Id
        });
        
        SelectedQuestionId = null;
    }

    private void AddNewQuestion()
    {
        if (string.IsNullOrWhiteSpace(NewQuestionText)) return;
        
        // Filter out options with empty labels
        var validOptions = NewQuestionRequiresOptions ? 
            NewQuestionOptions.Where(o => !string.IsNullOrWhiteSpace(o.Label)).ToList() : 
            null;
        
        var newQ = new CreateQuestionInSurveyDto
        {
            Text = NewQuestionText,
            Type = NewQuestionType,
            Options = validOptions
        };
        
        AttachedQuestions.Add(new AttachedQuestionItem
        {
            Text = NewQuestionText,
            Type = NewQuestionType,
            NewQuestionDto = newQ
        });
        
        // Reset form
        NewQuestionText = string.Empty;
        NewQuestionType = QuestionType.SingleChoice;
        NewQuestionOptions = new() { new CreateOptionInQuestionDto() };
    }

    private void AddNewQuestionOption()
    {
        NewQuestionOptions.Add(new CreateOptionInQuestionDto());
    }

    private void RemoveNewQuestionOption(int index)
    {
        if (NewQuestionOptions.Count > 1 && index >= 0 && index < NewQuestionOptions.Count)
        {
            NewQuestionOptions.RemoveAt(index);
        }
    }

    private void RemoveAttachedQuestion(AttachedQuestionItem item)
    {
        AttachedQuestions.Remove(item);
    }

    private async Task SaveSurveyAsync()
    {
        // Validate all new question options before submitting
        var hasInvalidOptions = NewQuestionOptions.Any(opt => !string.IsNullOrWhiteSpace(opt.Label) && !IsNewQuestionOptionLabelValid(opt));
        if (hasInvalidOptions)
        {
            StateHasChanged();
            return;
        }

        // Validate all attached questions' options
        foreach (var attachedQuestion in AttachedQuestions)
        {
            if (attachedQuestion.NewQuestionDto?.Options != null)
            {
                var hasInvalid = attachedQuestion.NewQuestionDto.Options.Any(opt => !string.IsNullOrWhiteSpace(opt.Label) && !IsLabelValidForType(opt.Label, opt.Type));
                if (hasInvalid)
                {
                    StateHasChanged();
                    return;
                }
            }
        }

        var existingIds = AttachedQuestions
            .Where(q => q.ExistingQuestionId != null)
            .Select(q => q.ExistingQuestionId!.Value)
            .ToList();
        
        var newQuestions = AttachedQuestions
            .Where(q => q.NewQuestionDto != null)
            .Select(q => q.NewQuestionDto!)
            .ToList();
        
        NewEntity.ExistingQuestionIds = existingIds.Any() ? existingIds : null;
        NewEntity.NewQuestions = newQuestions.Any() ? newQuestions : null;
        
        await CreateEntityAsync();
    }

    protected override Task OnCreatedEntityAsync()
    {
        CreateValidationsRef?.ClearAll();
        NewEntity = new CreateSurveyDto();
        NavigationManager.NavigateTo("/surveys");
        return Task.CompletedTask;
    }

    private void Back()
    {
        NavigationManager.NavigateTo("/surveys");
    }

    private DateTime? GetDateFromNewQuestionOption(CreateOptionInQuestionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return null;
        
        if (DateTime.TryParseExact(option.Label, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out var date))
            return date;
        
        if (DateTime.TryParse(option.Label, out var parsedDate))
            return parsedDate.Date;
        
        return null;
    }

    private void SetDateToNewQuestionOption(CreateOptionInQuestionDto option, DateTime? date)
    {
        option.Label = date?.ToString("yyyy-MM-dd") ?? string.Empty;
    }

    private DateTime? GetDateTimeFromNewQuestionOption(CreateOptionInQuestionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return null;
        
        if (DateTime.TryParse(option.Label, out var dateTime))
            return dateTime;
        
        return null;
    }

    private void SetDateTimeToNewQuestionOption(CreateOptionInQuestionDto option, DateTime? dateTime)
    {
        option.Label = dateTime?.ToString("yyyy-MM-ddTHH:mm:ss") ?? string.Empty;
    }

    private void OnNewQuestionOptionLabelChanged(CreateOptionInQuestionDto option, string value)
    {
        option.Label = value;
        StateHasChanged();
    }

    private void OnNewQuestionOptionTypeChanged(CreateOptionInQuestionDto option, OptionDataType newType)
    {
        // If the current label is not valid for the new type, clear it
        if (!string.IsNullOrWhiteSpace(option.Label) && !IsLabelValidForType(option.Label, newType))
        {
            option.Label = string.Empty;
        }
        option.Type = newType;
        StateHasChanged();
    }

    private bool IsNewQuestionOptionLabelValid(CreateOptionInQuestionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return true; // Empty is valid (optional field)
        
        return IsLabelValidForType(option.Label, option.Type);
    }

    private string GetNewQuestionOptionValidationMessage(CreateOptionInQuestionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return string.Empty;

        return option.Type switch
        {
            OptionDataType.String => LH.Localize("Error.EnterTextNotNumbersOnly"),
            OptionDataType.Int => LH.Localize("Error.EnterValidWholeNumber"),
            OptionDataType.Decimal => LH.Localize("Error.EnterValidDecimalNumber"),
            OptionDataType.Bool => LH.Localize("Error.SelectTrueOrFalse"),
            OptionDataType.Date => LH.Localize("Error.EnterValidDate"),
            OptionDataType.DateTime => LH.Localize("Error.EnterValidDateAndTime"),
            _ => string.Empty
        };
    }

    private bool IsLabelValidForType(string label, OptionDataType type)
    {
        if (string.IsNullOrWhiteSpace(label))
            return true;

        try
        {
            return type switch
            {
                OptionDataType.String => !IsPureNumber(label.Trim()), // String should not be a pure number
                OptionDataType.Int => int.TryParse(label.Trim(), System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out _),
                OptionDataType.Decimal => decimal.TryParse(label.Trim(), System.Globalization.NumberStyles.Number, System.Globalization.CultureInfo.InvariantCulture, out _),
                OptionDataType.Bool => bool.TryParse(label.Trim(), out _) || label.Trim() == "0" || label.Trim() == "1",
                OptionDataType.Date => DateTime.TryParseExact(label.Trim(), "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out _) ||
                                      DateTime.TryParse(label.Trim(), out _),
                OptionDataType.DateTime => DateTime.TryParseExact(label.Trim(), "o", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out _) ||
                                          DateTime.TryParse(label.Trim(), out _),
                _ => true
            };
        }
        catch
        {
            return false;
        }
    }

    private bool IsPureNumber(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return false;
        
        // Check if the value is a pure number (int or decimal)
        return int.TryParse(value, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out _) ||
               decimal.TryParse(value, System.Globalization.NumberStyles.Number, System.Globalization.CultureInfo.InvariantCulture, out _);
    }
}
