@page "/indicators"
@using Volo.Abp.Application.Dtos
@using Ejada.SurveyManager.Indicators
@using Ejada.SurveyManager.Indicators.Dtos
@using Ejada.SurveyManager.Surveys
@using Ejada.SurveyManager.Surveys.Dtos
@using Ejada.SurveyManager.Localization
@using Ejada.SurveyManager.Permissions
@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.AspNetCore.Components.Web
@inject IIndicatorAppService IndicatorAppService
@inject IQuestionAppService QuestionAppService
@inject NavigationManager NavigationManager
@inject Volo.Abp.AspNetCore.Components.Web.AbpBlazorMessageLocalizerHelper<SurveyManagerResource> LH
@inherits AbpCrudPageBase<IIndicatorAppService, IndicatorDto, Guid, PagedAndSortedResultRequestDto, CreateIndicatorDto, UpdateIndicatorDto>

<div class="modern-page-wrapper">
    <div class="glass-card">
        <div class="gradient-header">
            <div class="gradient-header-content">
                <Row Class="align-items-center justify-content-between g-3">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex align-items-center">
                            <div class="header-icon-box me-3">
                                <Icon Name="IconName.ChartLine" Size="IconSize.ExtraLarge" />
                            </div>
                            <div>
                                <h2 class="mb-1 fw-bold text-white">@LH.Localize("Indicators")</h2>
                                <p class="text-white-50 mb-0">@LH.Localize("ManageYourIndicators")</p>
                            </div>
                        </div>
                    </Column>
                    <Column ColumnSize="ColumnSize.IsAuto">
                        @if (HasCreatePermission)
                        {
                            <Button Color="Color.Primary" Clicked="OpenCreateModalAsync" Class="px-4 btn-modern">
                                <Icon Name="IconName.Add" />
                                @LH.Localize("CreateIndicator")
                            </Button>
                        }
                    </Column>
                </Row>
            </div>
        </div>
        <div class="px-4 pb-4">
            <DataGrid TItem="IndicatorDto"
                  Data="Entities"
                  ReadData="OnDataGridReadAsync"
                  TotalItems="TotalCount"
                  ShowPager="true"
                  PageSize="PageSize"
                  ShowFilterRow="true"
                  Striped="true"
                  Hoverable="true"
                  Responsive="true"
                  Class="border-0 modern-table">
            <DataGridColumns>
                <DataGridColumn TItem="IndicatorDto" Field="@nameof(IndicatorDto.Name)" Caption="@LH.Localize("IndicatorName")" Sortable="true">
                    <DisplayTemplate Context="context">
                        <div class="d-flex align-items-center">
                            <Icon Name="IconName.ChartBar" Class="text-primary me-2" />
                            <strong>@context.Name</strong>
                        </div>
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="IndicatorDto" Field="@nameof(IndicatorDto.Description)" Caption="@LH.Localize("Description")" Sortable="true">
                    <DisplayTemplate Context="context">
                        <span class="text-muted">@(context.Description?.Length > 60 ? context.Description.Substring(0, 60) + "..." : context.Description)</span>
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="IndicatorDto" Field="@nameof(IndicatorDto.IsActive)" Caption="@LH.Localize("IsActive")" Sortable="true">
                    <DisplayTemplate Context="context">
                        @if (context.IsActive)
                        {
                            <Badge Color="Color.Success">
                                <Icon Name="IconName.Check" />
                                @LH.Localize("Active")
                            </Badge>
                        }
                        else
                        {
                            <Badge Color="Color.Secondary">
                                <Icon Name="IconName.Times" />
                                @LH.Localize("Inactive")
                            </Badge>
                        }
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="IndicatorDto" Field="@nameof(IndicatorDto.QuestionIds)" Caption="@LH.Localize("LinkedQuestions")" Sortable="true">
                    <DisplayTemplate Context="context">
                        <Badge Color="Color.Info">
                            <Icon Name="IconName.Link" />
                            @context.QuestionIds.Count @LH.Localize("Questions")
                        </Badge>
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridEntityActionsColumn TItem="IndicatorDto" @ref="@EntityActionsColumn" Caption="@LH.Localize("Actions")" Width="180px">
                    <DisplayTemplate Context="context">
                        <EntityActions TItem="IndicatorDto" EntityActionsColumn="@EntityActionsColumn">
                            <EntityAction TItem="IndicatorDto" 
                                          Text="@LH.Localize("ViewDetails")"
                                          Icon="IconName.Eye"
                                          Clicked="() => NavigateToDetails(context.Id)" />
                            <EntityAction TItem="IndicatorDto" 
                                          Text="@LH.Localize("Edit")"
                                          Icon="IconName.Edit"
                                          Visible="@HasUpdatePermission" 
                                          Clicked="() => OpenEditModalAsync(context)" />
                            <EntityAction TItem="IndicatorDto" 
                                          Text="@LH.Localize("Delete")"
                                          Icon="IconName.Trash"
                                          Color="Color.Danger"
                                          Visible="@HasDeletePermission" 
                                          Clicked="() => DeleteEntityAsync(context)" 
                                          ConfirmationMessage="() => GetDeleteConfirmationMessage(context)" />
                        </EntityActions>
                    </DisplayTemplate>
                </DataGridEntityActionsColumn>
                
            </DataGridColumns>
        </DataGrid>
        </div>
    </div>
</div>

<!-- Create Modal -->
<Modal @ref="@CreateModal">
    <ModalContent Centered Size="ModalSize.Large">
        <Form>
            <ModalHeader>
                <ModalTitle>@LH.Localize("CreateIndicator")</ModalTitle>
                <CloseButton Clicked="CloseCreateModalAsync" />
            </ModalHeader>
            <ModalBody>
                <Validations @ref="@CreateValidationsRef" Model="@NewEntity" ValidateOnLoad="false">
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@LH.Localize("IndicatorName") *</FieldLabel>
                            <TextEdit @bind-Text="@NewEntity.Name">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </TextEdit>
                        </Field>
                    </Validation>
                    
                    <Field>
                        <FieldLabel>@LH.Localize("Description")</FieldLabel>
                        <MemoEdit @bind-Text="@NewEntity.Description" Rows="3" />
                    </Field>

                    <Field>
                        <Check TValue="bool" @bind-Checked="@NewEntity.IsActive">@LH.Localize("IsActive")</Check>
                    </Field>

                    <Field>
                        <FieldLabel>@LH.Localize("LinkedQuestions")</FieldLabel>
                        @if (AllQuestions != null && AllQuestions.Any())
                        {
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
                                @foreach (var question in AllQuestions)
                                {
                                    <Check TValue="bool" 
                                           Checked="@NewEntity.QuestionIds.Contains(question.Id)"
                                           CheckedChanged="@((bool isChecked) => OnQuestionSelectionChanged(question.Id, isChecked))">
                                        <strong>@question.Text</strong> <Badge Color="Color.Secondary">@question.Type</Badge>
                                    </Check>
                                }
                            </div>
                        }
                        else
                        {
                            <Alert Color="Color.Info" Visible>
                                @LH.Localize("Error.NoQuestionsAvailable")
                            </Alert>
                        }
                    </Field>
                </Validations>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="CloseCreateModalAsync">@LH.Localize("Cancel")</Button>
                <Button Color="Color.Primary" Type="@ButtonType.Submit" PreventDefaultOnSubmit Clicked="CreateEntityAsync">
                    @LH.Localize("Save")
                </Button>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

<!-- Edit Modal -->
<Modal @ref="@EditModal">
    <ModalContent Centered Size="ModalSize.Large">
        <Form>
            <ModalHeader>
                <ModalTitle>@LH.Localize("EditIndicator")</ModalTitle>
                <CloseButton Clicked="CloseEditModalAsync" />
            </ModalHeader>
            <ModalBody>
                <Validations @ref="@EditValidationsRef" Model="@EditingEntity" ValidateOnLoad="false">
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@LH.Localize("IndicatorName") *</FieldLabel>
                            <TextEdit @bind-Text="@EditingEntity.Name">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </TextEdit>
                        </Field>
                    </Validation>
                    
                    <Field>
                        <FieldLabel>@LH.Localize("Description")</FieldLabel>
                        <MemoEdit @bind-Text="@EditingEntity.Description" Rows="3" />
                    </Field>

                    <Field>
                        <Check TValue="bool" @bind-Checked="@EditingEntity.IsActive">@LH.Localize("IsActive")</Check>
                    </Field>

                    <Field>
                        <FieldLabel>@LH.Localize("LinkedQuestions")</FieldLabel>
                        @if (AllQuestions != null && AllQuestions.Any())
                        {
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
                                @foreach (var question in AllQuestions)
                                {
                                    <Check TValue="bool" 
                                           Checked="@EditingEntity.QuestionIds.Contains(question.Id)"
                                           CheckedChanged="@((bool isChecked) => OnEditQuestionSelectionChanged(question.Id, isChecked))">
                                        <strong>@question.Text</strong> <Badge Color="Color.Secondary">@question.Type</Badge>
                                    </Check>
                                }
                            </div>
                        }
                        else
                        {
                            <Alert Color="Color.Info" Visible>
                                @LH.Localize("Error.NoQuestionsAvailable")
                            </Alert>
                        }
                    </Field>
                </Validations>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="CloseEditModalAsync">@LH.Localize("Cancel")</Button>
                <Button Color="Color.Primary" Type="@ButtonType.Submit" PreventDefaultOnSubmit Clicked="UpdateEntityAsync">
                    @LH.Localize("Save")
                </Button>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

@code {
    private List<QuestionDto> AllQuestions = new List<QuestionDto>();
    private Modal EditModal;
    private Validations EditValidationsRef;
    private UpdateIndicatorDto EditingEntity = new UpdateIndicatorDto();

    public Indicators()
    {
        CreatePolicyName = SurveyManagerPermissions.Indicators.Create;
        UpdatePolicyName = SurveyManagerPermissions.Indicators.Edit;
        DeletePolicyName = SurveyManagerPermissions.Indicators.Delete;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadAllQuestionsAsync();
    }

    private async Task LoadAllQuestionsAsync()
    {
        var result = await QuestionAppService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
        AllQuestions = result.Items.ToList();
    }

    private void OnQuestionSelectionChanged(Guid questionId, bool isChecked)
    {
        if (isChecked)
        {
            if (!NewEntity.QuestionIds.Contains(questionId))
            {
                NewEntity.QuestionIds.Add(questionId);
            }
        }
        else
        {
            NewEntity.QuestionIds.Remove(questionId);
        }
    }

    private void OnEditQuestionSelectionChanged(Guid questionId, bool isChecked)
    {
        if (isChecked)
        {
            if (!EditingEntity.QuestionIds.Contains(questionId))
            {
                EditingEntity.QuestionIds.Add(questionId);
            }
        }
        else
        {
            EditingEntity.QuestionIds.Remove(questionId);
        }
    }

    protected override async Task OpenCreateModalAsync()
    {
        await base.OpenCreateModalAsync();
        NewEntity.QuestionIds = new List<Guid>();
        await LoadAllQuestionsAsync();
    }

    protected override async Task OpenEditModalAsync(IndicatorDto entity)
    {
        try
        {
            await CheckUpdatePolicyAsync();

            EditingEntityId = entity.Id;

            // Load the indicator with its question IDs
            var indicator = await AppService.GetAsync(entity.Id);

            // Populate the EditingEntity
            EditingEntity = new UpdateIndicatorDto
            {
                Name = indicator.Name,
                Description = indicator.Description,
                IsActive = indicator.IsActive,
                QuestionIds = indicator.QuestionIds ?? new List<Guid>()
            };

            await LoadAllQuestionsAsync();

            await InvokeAsync(async () =>
            {
                StateHasChanged();
                if (EditModal != null)
                {
                    await EditModal.Show();
                }
            });
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
    }

    private async Task CloseEditModalAsync()
    {
        await EditModal.Hide();
        EditingEntity = new UpdateIndicatorDto();
        EditingEntityId = Guid.Empty;
    }

    protected override async Task UpdateEntityAsync()
    {
        try
        {
            await CheckUpdatePolicyAsync();

            if (EditValidationsRef != null && !await EditValidationsRef.ValidateAll())
            {
                return;
            }

            await AppService.UpdateAsync(EditingEntityId, EditingEntity);
            await GetEntitiesAsync();
            await CloseEditModalAsync();
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
    }

    protected override string GetDeleteConfirmationMessage(IndicatorDto entity)
    {
        return string.Format(LH.Localize("Error.ConfirmDeleteIndicator"), entity.Name);
    }

    private void NavigateToDetails(Guid indicatorId)
    {
        NavigationManager.NavigateTo($"/indicators/{indicatorId}/details");
    }
}

