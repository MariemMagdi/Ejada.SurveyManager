@page "/questions/{Id:guid}/edit"
@using System.Collections.Generic
@using System.Linq
@using Ejada.SurveyManager.Surveys
@using Ejada.SurveyManager.Surveys.Dtos
@using Ejada.SurveyManager.Surveys.Enums
@using Ejada.SurveyManager.Indicators
@using Ejada.SurveyManager.Indicators.Dtos
@using Ejada.SurveyManager.Localization
@using Volo.Abp.Application.Dtos
@inject NavigationManager NavigationManager
@inject IQuestionAppService QuestionService
@inject IIndicatorAppService IndicatorAppService
@inject Volo.Abp.AspNetCore.Components.Web.AbpBlazorMessageLocalizerHelper<SurveyManagerResource> LH

@inherits AbpCrudPageBase<IQuestionAppService, QuestionDto, Guid, PagedAndSortedResultRequestDto, CreateQuestionDto, UpdateQuestionDto>

<div class="modern-page-wrapper">
    <div class="glass-card">
        <div class="gradient-header">
            <div class="gradient-header-content">
                <Row Class="align-items-center justify-content-between g-3">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <div class="d-flex align-items-center">
                            <div class="header-icon-box me-3">
                                <Icon Name="IconName.Edit" Size="IconSize.ExtraLarge" />
                            </div>
                            <div>
                                <h2 class="mb-1 fw-bold text-white">@LH.Localize("EditQuestion")</h2>
                                <p class="text-white-50 mb-0">@LH.Localize("UpdateQuestionInformation")</p>
                            </div>
                        </div>
                    </Column>
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <Button Color="Color.Secondary" Outline Clicked="Back" Class="btn-light">
                            <Icon Name="IconName.ArrowLeft" />
                            @LH.Localize("Back")
                        </Button>
                    </Column>
                </Row>
            </div>
        </div>

        <div class="px-4 pb-4">
        @if (LinkedSurveyNames.Any())
        {
            <Alert Color="Color.Warning" Visible="true" Class="mb-4">
                <AlertMessage>
                    <Icon Name="IconName.ExclamationTriangle" Class="me-2" />
                    <strong>@LH.Localize("Warning"):</strong> @LH.Localize("Error.QuestionLinkedToSurveysCannotEdit")
                </AlertMessage>
                <AlertDescription>
                    <ul class="mb-0 mt-2">
                        @foreach (var surveyName in LinkedSurveyNames)
                        {
                            <li>@surveyName</li>
                        }
                    </ul>
                </AlertDescription>
            </Alert>
        }

        <Form>
            <Validations @ref="@EditValidationsRef"
                         Model="@EditingEntity"
                         ValidateOnLoad="false"
                         @key="EditingEntity">
                <!-- Question Information -->
                <div class="dashboard-card mb-4">
                    <div class="dashboard-card-header">
                        <h5 class="dashboard-card-title">
                            <Icon Name="IconName.InfoCircle" Class="text-primary me-2" />
                            @LH.Localize("QuestionInformation")
                        </h5>
                    </div>
                    <div class="dashboard-card-body">
                        <Validation MessageLocalizer="@LH.Localize">
                            <Field>
                                <FieldLabel>@LH.Localize("QuestionText") *</FieldLabel>
                                <TextEdit @bind-Text="EditingEntity.Text" Disabled="@IsLinkedToSurvey" Placeholder="@LH.Localize("EnterQuestionText")">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </TextEdit>
                            </Field>
                        </Validation>

                        <Field>
                            <FieldLabel>@LH.Localize("QuestionType")</FieldLabel>
                            <Select TValue="QuestionType"
                                    SelectedValue="EditingEntity.Type"
                                    SelectedValueChanged="@(EventCallback.Factory.Create<QuestionType>(this, OnEditTypeChanged))"
                                    SelectedValueExpression="() => EditingEntity.Type"
                                    Disabled="@IsLinkedToSurvey">
                                @foreach (var type in QuestionTypes)
                                {
                                    <SelectItem Value="@type">@type.ToString()</SelectItem>
                                }
                            </Select>
                        </Field>

                        @if (EditRequiresOptions)
                        {
                            <Field>
                                <FieldLabel>@LH.Localize("Options")</FieldLabel>
                                <div class="border rounded p-3 bg-light">
                                    @for (var i = 0; i < EditOptionInputs.Count; i++)
                                    {
                                        var option = EditOptionInputs[i];
                                        var currentIndex = i;
                                        <Row class="align-items-end mb-2" @key="option">
                                            <Column>
                                                @if (option.Type == OptionDataType.String)
                                                {
                                                    <TextEdit Text="@option.Label"
                                                              TextChanged="@((string value) => OnOptionLabelChanged(option, value))"
                                                              Placeholder="@LH.Localize("OptionLabel")"
                                                              Disabled="@IsLinkedToSurvey"
                                                              Color="@(IsOptionLabelValid(option) ? null : Color.Danger)" />
                                                    @if (!IsOptionLabelValid(option) && !string.IsNullOrWhiteSpace(option.Label))
                                                    {
                                                        <small class="text-danger d-block mt-1">@GetOptionValidationMessage(option)</small>
                                                    }
                                                }
                                                else if (option.Type == OptionDataType.Int)
                                                {
                                                    <TextEdit Text="@option.Label"
                                                              TextChanged="@((string value) => OnOptionLabelChanged(option, value))"
                                                              Type="TextInputType.Number"
                                                              Placeholder="@LH.Localize("EnterWholeNumber")"
                                                              Disabled="@IsLinkedToSurvey"
                                                              Color="@(IsOptionLabelValid(option) ? null : Color.Danger)" />
                                                    @if (!IsOptionLabelValid(option) && !string.IsNullOrWhiteSpace(option.Label))
                                                    {
                                                        <small class="text-danger d-block mt-1">@GetOptionValidationMessage(option)</small>
                                                    }
                                                }
                                                else if (option.Type == OptionDataType.Decimal)
                                                {
                                                    <TextEdit Text="@option.Label"
                                                              TextChanged="@((string value) => OnOptionLabelChanged(option, value))"
                                                              Type="TextInputType.Number"
                                                              Step="0.01"
                                                              Placeholder="@LH.Localize("EnterDecimalNumber")"
                                                              Disabled="@IsLinkedToSurvey"
                                                              Color="@(IsOptionLabelValid(option) ? null : Color.Danger)" />
                                                    @if (!IsOptionLabelValid(option) && !string.IsNullOrWhiteSpace(option.Label))
                                                    {
                                                        <small class="text-danger d-block mt-1">@GetOptionValidationMessage(option)</small>
                                                    }
                                                }
                                                else if (option.Type == OptionDataType.Bool)
                                                {
                                                    <Select TValue="string" SelectedValue="@option.Label" 
                                                            SelectedValueChanged="@((string value) => OnOptionLabelChanged(option, value))"
                                                            Disabled="@IsLinkedToSurvey"
                                                            Color="@(IsOptionLabelValid(option) ? null : Color.Danger)">
                                                        <SelectItem Value="true">True</SelectItem>
                                                        <SelectItem Value="false">False</SelectItem>
                                                    </Select>
                                                    @if (!IsOptionLabelValid(option) && !string.IsNullOrWhiteSpace(option.Label))
                                                    {
                                                        <small class="text-danger d-block mt-1">@GetOptionValidationMessage(option)</small>
                                                    }
                                                }
                                                else if (option.Type == OptionDataType.Date)
                                                {
                                                    <DateEdit TValue="DateTime?" 
                                                              Date="@GetDateFromOption(option)"
                                                              DateChanged="@((DateTime? date) => { SetDateToOption(option, date); OnOptionLabelChanged(option, option.Label); })"
                                                              DisplayFormat="yyyy-MM-dd"
                                                              Disabled="@IsLinkedToSurvey" />
                                                    @if (!IsOptionLabelValid(option) && !string.IsNullOrWhiteSpace(option.Label))
                                                    {
                                                        <small class="text-danger d-block mt-1">@GetOptionValidationMessage(option)</small>
                                                    }
                                                }
                                                else if (option.Type == OptionDataType.DateTime)
                                                {
                                                    <DateEdit TValue="DateTime?" 
                                                              Date="@GetDateTimeFromOption(option)"
                                                              DateChanged="@((DateTime? date) => { SetDateTimeToOption(option, date); OnOptionLabelChanged(option, option.Label); })"
                                                              InputMode="DateInputMode.DateTime"
                                                              DisplayFormat="yyyy-MM-dd HH:mm"
                                                              Disabled="@IsLinkedToSurvey" />
                                                    @if (!IsOptionLabelValid(option) && !string.IsNullOrWhiteSpace(option.Label))
                                                    {
                                                        <small class="text-danger d-block mt-1">@GetOptionValidationMessage(option)</small>
                                                    }
                                                }
                                            </Column>
                                            <Column ColumnSize="ColumnSize.IsAuto">
                                                <Select TValue="OptionDataType" SelectedValue="@option.Type" 
                                                        SelectedValueChanged="@((OptionDataType newType) => OnOptionTypeChanged(option, newType))"
                                                        Disabled="@IsLinkedToSurvey">
                                                    @foreach (var dataType in OptionDataTypes)
                                                    {
                                                        <SelectItem Value="@dataType">@dataType.ToString()</SelectItem>
                                                    }
                                                </Select>
                                            </Column>
                                            <Column ColumnSize="ColumnSize.IsAuto">
                                                <Button Color="Color.Danger"
                                                        Size="Size.Small"
                                                        Outline
                                                        Disabled="@(EditOptionInputs.Count <= 1 || IsLinkedToSurvey)"
                                                        Clicked="@(() => RemoveEditOption(currentIndex))">
                                                    <Icon Name="IconName.Delete" />
                                                </Button>
                                            </Column>
                                        </Row>
                                    }
                                    <Button Color="Color.Secondary" Outline Clicked="AddEditOption" Disabled="@IsLinkedToSurvey">
                                        <Icon Name="IconName.Add" />
                                        @LH.Localize("AddOption")
                                    </Button>
                                </div>
                            </Field>
                        }
                    </div>
                </div>

                <!-- Linked Indicators -->
                <div class="dashboard-card mb-4">
                    <div class="dashboard-card-header">
                        <h5 class="dashboard-card-title">
                            <Icon Name="IconName.ChartLine" Class="text-primary me-2" />
                            @LH.Localize("LinkedIndicators")
                        </h5>
                    </div>
                    <div class="dashboard-card-body">
                        @if (AllIndicators != null && AllIndicators.Any())
                        {
                            <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                @foreach (var indicator in AllIndicators)
                                {
                                    <div class="mb-2">
                                        <Check TValue="bool" 
                                               Checked="@EditingEntity.IndicatorIds.Contains(indicator.Id)"
                                               CheckedChanged="@((bool isChecked) => OnIndicatorSelectionChanged(indicator.Id, isChecked))"
                                               Disabled="@IsLinkedToSurvey">
                                            <strong>@indicator.Name</strong>
                                            @if (!string.IsNullOrEmpty(indicator.Description))
                                            {
                                                <span class="text-muted"> - @indicator.Description</span>
                                            }
                                        </Check>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <Alert Color="Color.Info" Visible>
                                <Icon Name="IconName.InfoCircle" Class="me-2" />
                                @LH.Localize("Error.NoIndicatorsAvailable")
                            </Alert>
                        }
                    </div>
                </div>
            </Validations>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <Button Color="Color.Primary" Outline Clicked="Back">
                    <Icon Name="IconName.Times" />
                    @LH.Localize("Cancel")
                </Button>

                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="UpdateQuestionAsync"
                        Disabled="@IsLinkedToSurvey"
                        Class="px-5 btn-modern">
                    <Icon Name="IconName.Save" />
                    @LH.Localize("Save")
                </Button>
            </div>
        </Form>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private List<UpdateOptionDto> EditOptionInputs { get; set; } = new();
    private List<string> LinkedSurveyNames { get; set; } = new();
    private List<IndicatorDto> AllIndicators { get; set; } = new();
    private bool IsLinkedToSurvey => LinkedSurveyNames.Any();

    private static IEnumerable<QuestionType> QuestionTypes => Enum.GetValues<QuestionType>();
    private static IEnumerable<OptionDataType> OptionDataTypes => Enum.GetValues<OptionDataType>();

    private bool EditRequiresOptions => RequiresOptionsForType(EditingEntity?.Type ?? QuestionType.SingleChoice);

    protected override async Task OnParametersSetAsync()
    {
        var dto = await QuestionService.GetAsync(Id);
        EditingEntityId = Id;
        EditingEntity = new UpdateQuestionDto
        {
            Text = dto.Text,
            Type = dto.Type,
            Options = dto.Options.Select(o => new UpdateOptionDto
            {
                Id = o.Id,
                Label = o.Label,
                Type = o.Type
            }).ToList(),
            IndicatorIds = dto.IndicatorIds ?? new List<Guid>()
        };

        EditOptionInputs = EditingEntity.Options?.ToList() ?? new List<UpdateOptionDto>();
        EnsureEditOptionDefaults();

        // Check if this question is linked to any surveys
        LinkedSurveyNames = await QuestionService.GetLinkedSurveyNamesAsync(Id);

        // Load all indicators
        await LoadAllIndicatorsAsync();
    }

    private async Task LoadAllIndicatorsAsync()
    {
        var result = await IndicatorAppService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
        AllIndicators = result.Items.ToList();
    }

    private void OnIndicatorSelectionChanged(Guid indicatorId, bool isChecked)
    {
        if (isChecked)
        {
            if (!EditingEntity.IndicatorIds.Contains(indicatorId))
            {
                EditingEntity.IndicatorIds.Add(indicatorId);
            }
        }
        else
        {
            EditingEntity.IndicatorIds.Remove(indicatorId);
        }
    }

    private static bool RequiresOptionsForType(QuestionType type)
    {
        return type == QuestionType.SingleChoice || type == QuestionType.MultiChoice;
    }

    private void EnsureEditOptionDefaults()
    {
        if (EditRequiresOptions && EditOptionInputs.Count == 0)
        {
            EditOptionInputs.Add(new UpdateOptionDto { Id = Guid.Empty });
        }

        if (!EditRequiresOptions && EditOptionInputs.Count > 0)
        {
            EditOptionInputs.Clear();
        }

        if (EditingEntity != null)
        {
            EditingEntity.Options = EditRequiresOptions ? EditOptionInputs : null;
        }
    }

    private Task OnEditTypeChanged(QuestionType newType)
    {
        if (EditingEntity != null)
        {
            EditingEntity.Type = newType;
            EnsureEditOptionDefaults();
        }
        return Task.CompletedTask;
    }

    private void AddEditOption()
    {
        EditOptionInputs.Add(new UpdateOptionDto { Id = Guid.Empty });
        EnsureEditOptionDefaults();
    }

    private void RemoveEditOption(int index)
    {
        if (index >= 0 && index < EditOptionInputs.Count)
        {
            EditOptionInputs.RemoveAt(index);
        }
        EnsureEditOptionDefaults();
    }

    private async Task UpdateQuestionAsync()
    {
        // Validate all options before submitting
        var hasInvalidOptions = EditOptionInputs.Any(opt => !string.IsNullOrWhiteSpace(opt.Label) && !IsOptionLabelValid(opt));
        if (hasInvalidOptions)
        {
            StateHasChanged();
            return;
        }

        EnsureEditOptionDefaults();
        await UpdateEntityAsync();
    }

    protected override Task OnUpdatedEntityAsync()
    {
        EditValidationsRef?.ClearAll();
        NavigationManager.NavigateTo("/questions");
        return Task.CompletedTask;
    }

    private void Back()
    {
        NavigationManager.NavigateTo("/questions");
    }

    private DateTime? GetDateFromOption(UpdateOptionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return null;
        
        if (DateTime.TryParseExact(option.Label, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out var date))
            return date;
        
        if (DateTime.TryParse(option.Label, out var parsedDate))
            return parsedDate.Date;
        
        return null;
    }

    private void SetDateToOption(UpdateOptionDto option, DateTime? date)
    {
        option.Label = date?.ToString("yyyy-MM-dd") ?? string.Empty;
    }

    private DateTime? GetDateTimeFromOption(UpdateOptionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return null;
        
        if (DateTime.TryParse(option.Label, out var dateTime))
            return dateTime;
        
        return null;
    }

    private void SetDateTimeToOption(UpdateOptionDto option, DateTime? dateTime)
    {
        option.Label = dateTime?.ToString("yyyy-MM-ddTHH:mm:ss") ?? string.Empty;
    }

    private void OnOptionLabelChanged(UpdateOptionDto option, string value)
    {
        option.Label = value;
        StateHasChanged();
    }

    private void OnOptionTypeChanged(UpdateOptionDto option, OptionDataType newType)
    {
        // If the current label is not valid for the new type, clear it
        if (!string.IsNullOrWhiteSpace(option.Label) && !IsLabelValidForType(option.Label, newType))
        {
            option.Label = string.Empty;
        }
        option.Type = newType;
        StateHasChanged();
    }

    private bool IsOptionLabelValid(UpdateOptionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return true; // Empty is valid (optional field)
        
        return IsLabelValidForType(option.Label, option.Type);
    }

    private string GetOptionValidationMessage(UpdateOptionDto option)
    {
        if (string.IsNullOrWhiteSpace(option.Label))
            return string.Empty;

        return option.Type switch
        {
            OptionDataType.String => LH.Localize("Error.EnterTextNotNumbersOnly"),
            OptionDataType.Int => LH.Localize("Error.EnterValidWholeNumber"),
            OptionDataType.Decimal => LH.Localize("Error.EnterValidDecimalNumber"),
            OptionDataType.Bool => LH.Localize("Error.SelectTrueOrFalse"),
            OptionDataType.Date => LH.Localize("Error.EnterValidDate"),
            OptionDataType.DateTime => LH.Localize("Error.EnterValidDateAndTime"),
            _ => string.Empty
        };
    }

    private bool IsLabelValidForType(string label, OptionDataType type)
    {
        if (string.IsNullOrWhiteSpace(label))
            return true;

        try
        {
            return type switch
            {
                OptionDataType.String => !IsPureNumber(label.Trim()), // String should not be a pure number
                OptionDataType.Int => int.TryParse(label.Trim(), System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out _),
                OptionDataType.Decimal => decimal.TryParse(label.Trim(), System.Globalization.NumberStyles.Number, System.Globalization.CultureInfo.InvariantCulture, out _),
                OptionDataType.Bool => bool.TryParse(label.Trim(), out _) || label.Trim() == "0" || label.Trim() == "1",
                OptionDataType.Date => DateTime.TryParseExact(label.Trim(), "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out _) ||
                                      DateTime.TryParse(label.Trim(), out _),
                OptionDataType.DateTime => DateTime.TryParseExact(label.Trim(), "o", System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out _) ||
                                          DateTime.TryParse(label.Trim(), out _),
                _ => true
            };
        }
        catch
        {
            return false;
        }
    }

    private bool IsPureNumber(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return false;
        
        // Check if the value is a pure number (int or decimal)
        return int.TryParse(value, System.Globalization.NumberStyles.Integer, System.Globalization.CultureInfo.InvariantCulture, out _) ||
               decimal.TryParse(value, System.Globalization.NumberStyles.Number, System.Globalization.CultureInfo.InvariantCulture, out _);
    }
}

