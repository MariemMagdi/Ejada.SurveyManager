@page "/questions/{Id:guid}/edit"
@using System.Collections.Generic
@using System.Linq
@using Ejada.SurveyManager.Surveys
@using Ejada.SurveyManager.Surveys.Dtos
@using Ejada.SurveyManager.Surveys.Enums
@using Ejada.SurveyManager.Indicators
@using Ejada.SurveyManager.Indicators.Dtos
@using Ejada.SurveyManager.Localization
@using Volo.Abp.Application.Dtos
@inject NavigationManager NavigationManager
@inject IQuestionAppService QuestionService
@inject IIndicatorAppService IndicatorAppService
@inject Volo.Abp.AspNetCore.Components.Web.AbpBlazorMessageLocalizerHelper<SurveyManagerResource> LH

@inherits AbpCrudPageBase<IQuestionAppService, QuestionDto, Guid, PagedAndSortedResultRequestDto, CreateQuestionDto, UpdateQuestionDto>

<Card>
    <CardHeader>
        <Row class="justify-content-between">
            <Column ColumnSize="ColumnSize.IsAuto">
                <h2>@L["EditQuestion"]</h2>
            </Column>
            <Column ColumnSize="ColumnSize.IsAuto">
                <Button Color="Color.Secondary" Clicked="Back">
                    @L["Back"]
                </Button>
            </Column>
        </Row>
    </CardHeader>

    <CardBody>
        @if (LinkedSurveyNames.Any())
        {
            <Alert Color="Color.Warning" Visible="true">
                <AlertMessage>
                    <strong>@L["Warning"]:</strong> This question is linked to the following survey(s) and cannot be edited:
                </AlertMessage>
                <AlertDescription>
                    <ul class="mb-0">
                        @foreach (var surveyName in LinkedSurveyNames)
                        {
                            <li>@surveyName</li>
                        }
                    </ul>
                </AlertDescription>
            </Alert>
        }

        <Form>
            <Validations @ref="@EditValidationsRef"
                         Model="@EditingEntity"
                         ValidateOnLoad="false"
                         @key="EditingEntity">
                <Validation MessageLocalizer="@LH.Localize">
                    <Field>
                        <FieldLabel>@L["QuestionText"]</FieldLabel>
                        <TextEdit @bind-Text="EditingEntity.Text" Disabled="@IsLinkedToSurvey">
                            <Feedback>
                                <ValidationError />
                            </Feedback>
                        </TextEdit>
                    </Field>
                </Validation>

                <Field>
                    <FieldLabel>@L["QuestionType"]</FieldLabel>
                    <InputSelect TValue="QuestionType"
                                 Value="EditingEntity.Type"
                                 ValueChanged="@(EventCallback.Factory.Create<QuestionType>(this, OnEditTypeChanged))"
                                 ValueExpression="() => EditingEntity.Type"
                                 class="form-select"
                                 disabled="@IsLinkedToSurvey">
                        @foreach (var type in QuestionTypes)
                        {
                            <option value="@type">@type</option>
                        }
                    </InputSelect>
                </Field>

                @if (EditRequiresOptions)
                {
                    <Field>
                        <FieldLabel>@L["Options"]</FieldLabel>
                        <div class="mb-2">
                            @for (var i = 0; i < EditOptionInputs.Count; i++)
                            {
                                var option = EditOptionInputs[i];
                                var currentIndex = i; // Capture the index in a local variable
                                <Row class="align-items-end mb-2" @key="option">
                                    <Column>
                                        <TextEdit @bind-Text="option.Label"
                                                  Placeholder="@L["OptionLabel"]"
                                                  Disabled="@IsLinkedToSurvey" />
                                    </Column>
                                    <Column ColumnSize="ColumnSize.IsAuto">
                                        <InputSelect @bind-Value="option.Type" class="form-select" disabled="@IsLinkedToSurvey">
                                            @foreach (var dataType in OptionDataTypes)
                                            {
                                                <option value="@dataType">@dataType</option>
                                            }
                                        </InputSelect>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.IsAuto">
                                        <Button Color="Color.Danger"
                                                Disabled="@(EditOptionInputs.Count <= 1 || IsLinkedToSurvey)"
                                                Clicked="@(() => RemoveEditOption(currentIndex))">
                                            @L["Remove"]
                                        </Button>
                                    </Column>
                                </Row>
                            }
                        </div>
                        <Button Color="Color.Secondary" Clicked="AddEditOption" Disabled="@IsLinkedToSurvey">
                            @L["AddOption"]
                        </Button>
                    </Field>
                }

                <Field>
                    <FieldLabel>@L["LinkedIndicators"]</FieldLabel>
                    @if (AllIndicators != null && AllIndicators.Any())
                    {
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
                            @foreach (var indicator in AllIndicators)
                            {
                                <Check TValue="bool" 
                                       Checked="@EditingEntity.IndicatorIds.Contains(indicator.Id)"
                                       CheckedChanged="@((bool isChecked) => OnIndicatorSelectionChanged(indicator.Id, isChecked))"
                                       Disabled="@IsLinkedToSurvey">
                                    <strong>@indicator.Name</strong>
                                    @if (!string.IsNullOrEmpty(indicator.Description))
                                    {
                                        <span class="text-muted"> - @indicator.Description</span>
                                    }
                                </Check>
                            }
                        </div>
                    }
                    else
                    {
                        <Alert Color="Color.Info" Visible>
                            @L["NoIndicatorsAvailable"]
                        </Alert>
                    }
                </Field>
            </Validations>

            <div class="mt-3">
                <Button Color="Color.Secondary" Clicked="Back">
                    @L["Cancel"]
                </Button>

                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="UpdateQuestionAsync"
                        Disabled="@IsLinkedToSurvey">
                    @L["Save"]
                </Button>
            </div>
        </Form>
    </CardBody>
</Card>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private List<UpdateOptionDto> EditOptionInputs { get; set; } = new();
    private List<string> LinkedSurveyNames { get; set; } = new();
    private List<IndicatorDto> AllIndicators { get; set; } = new();
    private bool IsLinkedToSurvey => LinkedSurveyNames.Any();

    private static IEnumerable<QuestionType> QuestionTypes => Enum.GetValues<QuestionType>();
    private static IEnumerable<OptionDataType> OptionDataTypes => Enum.GetValues<OptionDataType>();

    private bool EditRequiresOptions => RequiresOptionsForType(EditingEntity?.Type ?? QuestionType.SingleChoice);

    protected override async Task OnParametersSetAsync()
    {
        var dto = await QuestionService.GetAsync(Id);
        EditingEntityId = Id;
        EditingEntity = new UpdateQuestionDto
        {
            Text = dto.Text,
            Type = dto.Type,
            Options = dto.Options.Select(o => new UpdateOptionDto
            {
                Id = o.Id,
                Label = o.Label,
                Type = o.Type
            }).ToList(),
            IndicatorIds = dto.IndicatorIds ?? new List<Guid>()
        };

        EditOptionInputs = EditingEntity.Options?.ToList() ?? new List<UpdateOptionDto>();
        EnsureEditOptionDefaults();

        // Check if this question is linked to any surveys
        LinkedSurveyNames = await QuestionService.GetLinkedSurveyNamesAsync(Id);

        // Load all indicators
        await LoadAllIndicatorsAsync();
    }

    private async Task LoadAllIndicatorsAsync()
    {
        var result = await IndicatorAppService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
        AllIndicators = result.Items.ToList();
    }

    private void OnIndicatorSelectionChanged(Guid indicatorId, bool isChecked)
    {
        if (isChecked)
        {
            if (!EditingEntity.IndicatorIds.Contains(indicatorId))
            {
                EditingEntity.IndicatorIds.Add(indicatorId);
            }
        }
        else
        {
            EditingEntity.IndicatorIds.Remove(indicatorId);
        }
    }

    private static bool RequiresOptionsForType(QuestionType type)
    {
        return type == QuestionType.SingleChoice || type == QuestionType.MultiChoice;
    }

    private void EnsureEditOptionDefaults()
    {
        if (EditRequiresOptions && EditOptionInputs.Count == 0)
        {
            EditOptionInputs.Add(new UpdateOptionDto { Id = Guid.Empty });
        }

        if (!EditRequiresOptions && EditOptionInputs.Count > 0)
        {
            EditOptionInputs.Clear();
        }

        if (EditingEntity != null)
        {
            EditingEntity.Options = EditRequiresOptions ? EditOptionInputs : null;
        }
    }

    private Task OnEditTypeChanged(QuestionType newType)
    {
        if (EditingEntity != null)
        {
            EditingEntity.Type = newType;
            EnsureEditOptionDefaults();
        }
        return Task.CompletedTask;
    }

    private void AddEditOption()
    {
        EditOptionInputs.Add(new UpdateOptionDto { Id = Guid.Empty });
        EnsureEditOptionDefaults();
    }

    private void RemoveEditOption(int index)
    {
        if (index >= 0 && index < EditOptionInputs.Count)
        {
            EditOptionInputs.RemoveAt(index);
        }
        EnsureEditOptionDefaults();
    }

    private async Task UpdateQuestionAsync()
    {
        EnsureEditOptionDefaults();
        await UpdateEntityAsync();
    }

    protected override Task OnUpdatedEntityAsync()
    {
        EditValidationsRef?.ClearAll();
        NavigationManager.NavigateTo("/questions");
        return Task.CompletedTask;
    }

    private void Back()
    {
        NavigationManager.NavigateTo("/questions");
    }
}

