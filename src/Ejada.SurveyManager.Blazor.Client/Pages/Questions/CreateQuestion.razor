@page "/questions/create"
@using System.Collections.Generic
@using Ejada.SurveyManager.Surveys
@using Ejada.SurveyManager.Surveys.Dtos
@using Ejada.SurveyManager.Surveys.Enums
@using Ejada.SurveyManager.Indicators
@using Ejada.SurveyManager.Indicators.Dtos
@using Ejada.SurveyManager.Localization
@using Volo.Abp.Application.Dtos
@inject NavigationManager NavigationManager
@inject IQuestionAppService QuestionService
@inject IIndicatorAppService IndicatorAppService
@inject Volo.Abp.AspNetCore.Components.Web.AbpBlazorMessageLocalizerHelper<SurveyManagerResource> LH

@inherits AbpCrudPageBase<IQuestionAppService, QuestionDto, Guid, PagedAndSortedResultRequestDto, CreateQuestionDto, UpdateQuestionDto>

<Card Class="shadow-sm">
    <CardHeader Class="bg-white border-bottom">
        <Row Class="align-items-center justify-content-between g-3">
            <Column ColumnSize="ColumnSize.IsAuto">
                <div class="d-flex align-items-center">
                    <Icon Name="IconName.Add" Class="text-primary me-2" Size="IconSize.Large" />
                    <div>
                        <h4 class="mb-0 fw-bold">@L["New Question"]</h4>
                        <small class="text-muted">@L["Create a new question"]</small>
                    </div>
                </div>
            </Column>
            <Column ColumnSize="ColumnSize.IsAuto">
                <Button Color="Color.Secondary" Outline Clicked="Back">
                    <Icon Name="IconName.ArrowLeft" />
                    @L["Back"]
                </Button>
            </Column>
        </Row>
    </CardHeader>

    <CardBody Class="p-4">
        <Form>
            <Validations @ref="@CreateValidationsRef"
                         Model="@NewEntity"
                         ValidateOnLoad="false"
                         @key="NewEntity">
                <!-- Question Information -->
                <Card Class="mb-4 border-0 shadow-sm">
                    <CardHeader Class="bg-light">
                        <h5 class="mb-0 fw-semibold d-flex align-items-center">
                            <Icon Name="IconName.InfoCircle" Class="text-primary me-2" />
                            @L["Question Information"]
                        </h5>
                    </CardHeader>
                    <CardBody>
                        <Validation MessageLocalizer="@LH.Localize">
                            <Field>
                                <FieldLabel>@L["Question Text"] *</FieldLabel>
                                <TextEdit @bind-Text="NewEntity.Text" Placeholder="@L["Enter question text"]">
                                    <Feedback>
                                        <ValidationError />
                                    </Feedback>
                                </TextEdit>
                            </Field>
                        </Validation>

                        <Field>
                            <FieldLabel>@L["Question Type"]</FieldLabel>
                            <Select TValue="QuestionType"
                                    SelectedValue="NewEntity.Type"
                                    SelectedValueChanged="@(EventCallback.Factory.Create<QuestionType>(this, OnCreateTypeChanged))"
                                    SelectedValueExpression="() => NewEntity.Type">
                                @foreach (var type in QuestionTypes)
                                {
                                    <SelectItem Value="@type">@type.ToString()</SelectItem>
                                }
                            </Select>
                        </Field>

                        @if (CreateRequiresOptions)
                        {
                            <Field>
                                <FieldLabel>@L["Options"]</FieldLabel>
                                <div class="border rounded p-3 bg-light">
                                    @for (var i = 0; i < CreateOptionInputs.Count; i++)
                                    {
                                        var option = CreateOptionInputs[i];
                                        var currentIndex = i;
                                        <Row class="align-items-end mb-2" @key="option">
                                            <Column>
                                                <TextEdit @bind-Text="option.Label"
                                                          Placeholder="@L["Option Label"]" />
                                            </Column>
                                            <Column ColumnSize="ColumnSize.IsAuto">
                                                <Select TValue="OptionDataType" @bind-SelectedValue="option.Type">
                                                    @foreach (var dataType in OptionDataTypes)
                                                    {
                                                        <SelectItem Value="@dataType">@dataType.ToString()</SelectItem>
                                                    }
                                                </Select>
                                            </Column>
                                            <Column ColumnSize="ColumnSize.IsAuto">
                                                <Button Color="Color.Danger"
                                                        Size="Size.Small"
                                                        Outline
                                                        Disabled="@(CreateOptionInputs.Count <= 1)"
                                                        Clicked="@(() => RemoveCreateOption(currentIndex))">
                                                    <Icon Name="IconName.Delete" />
                                                </Button>
                                            </Column>
                                        </Row>
                                    }
                                    <Button Color="Color.Secondary" Outline Clicked="AddCreateOption">
                                        <Icon Name="IconName.Add" />
                                        @L["AddOption"]
                                    </Button>
                                </div>
                            </Field>
                        }
                    </CardBody>
                </Card>

                <!-- Linked Indicators -->
                <Card Class="mb-4 border-0 shadow-sm">
                    <CardHeader Class="bg-light">
                        <h5 class="mb-0 fw-semibold d-flex align-items-center">
                            <Icon Name="IconName.ChartLine" Class="text-primary me-2" />
                            @L["Linked Indicators"]
                        </h5>
                    </CardHeader>
                    <CardBody>
                        @if (AllIndicators != null && AllIndicators.Any())
                        {
                            <div class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                @foreach (var indicator in AllIndicators)
                                {
                                    <div class="mb-2">
                                        <Check TValue="bool" 
                                               Checked="@NewEntity.IndicatorIds.Contains(indicator.Id)"
                                               CheckedChanged="@((bool isChecked) => OnIndicatorSelectionChanged(indicator.Id, isChecked))">
                                            <strong>@indicator.Name</strong>
                                            @if (!string.IsNullOrEmpty(indicator.Description))
                                            {
                                                <span class="text-muted"> - @indicator.Description</span>
                                            }
                                        </Check>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <Alert Color="Color.Info" Visible>
                                <Icon Name="IconName.InfoCircle" Class="me-2" />
                                @L["No indicators available. Please create indicators first."]
                            </Alert>
                        }
                    </CardBody>
                </Card>
            </Validations>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <Button Color="Color.Secondary" Outline Clicked="Back">
                    <Icon Name="IconName.Times" />
                    @L["Cancel"]
                </Button>

                <Button Color="Color.Primary"
                        Type="@ButtonType.Submit"
                        PreventDefaultOnSubmit="true"
                        Clicked="CreateQuestionAsync"
                        Class="px-5">
                    <Icon Name="IconName.Save" />
                    @L["Save"]
                </Button>
            </div>
        </Form>
    </CardBody>
</Card>

@code {
    private List<CreateOptionDto> CreateOptionInputs { get; set; } = new();
    private List<IndicatorDto> AllIndicators { get; set; } = new();

    private static IEnumerable<QuestionType> QuestionTypes => Enum.GetValues<QuestionType>();
    private static IEnumerable<OptionDataType> OptionDataTypes => Enum.GetValues<OptionDataType>();

    private bool CreateRequiresOptions => RequiresOptionsForType(NewEntity?.Type ?? QuestionType.SingleChoice);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (NewEntity != null && !Enum.IsDefined(typeof(QuestionType), NewEntity.Type))
        {
            NewEntity.Type = QuestionType.SingleChoice;
        }
        EnsureCreateOptionDefaults();
        await LoadAllIndicatorsAsync();
    }

    private async Task LoadAllIndicatorsAsync()
    {
        var result = await IndicatorAppService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
        AllIndicators = result.Items.ToList();
    }

    private void OnIndicatorSelectionChanged(Guid indicatorId, bool isChecked)
    {
        if (isChecked)
        {
            if (!NewEntity.IndicatorIds.Contains(indicatorId))
            {
                NewEntity.IndicatorIds.Add(indicatorId);
            }
        }
        else
        {
            NewEntity.IndicatorIds.Remove(indicatorId);
        }
    }

    private static bool RequiresOptionsForType(QuestionType type)
    {
        return type == QuestionType.SingleChoice || type == QuestionType.MultiChoice;
    }

    private void EnsureCreateOptionDefaults()
    {
        if (CreateRequiresOptions && CreateOptionInputs.Count == 0)
        {
            CreateOptionInputs.Add(new CreateOptionDto());
        }

        if (!CreateRequiresOptions && CreateOptionInputs.Count > 0)
        {
            CreateOptionInputs.Clear();
        }

        if (NewEntity != null)
        {
            NewEntity.Options = CreateRequiresOptions ? CreateOptionInputs : null;
        }
    }

    private Task OnCreateTypeChanged(QuestionType newType)
    {
        if (NewEntity != null)
        {
            NewEntity.Type = newType;
        }
        EnsureCreateOptionDefaults();
        return Task.CompletedTask;
    }

    private void AddCreateOption()
    {
        CreateOptionInputs.Add(new CreateOptionDto());
        EnsureCreateOptionDefaults();
    }

    private void RemoveCreateOption(int index)
    {
        if (index >= 0 && index < CreateOptionInputs.Count)
        {
            CreateOptionInputs.RemoveAt(index);
        }
        EnsureCreateOptionDefaults();
    }

    private async Task CreateQuestionAsync()
    {
        EnsureCreateOptionDefaults();
        await CreateEntityAsync();
    }

    protected override Task OnCreatedEntityAsync()
    {
        CreateValidationsRef?.ClearAll();
        NewEntity = new CreateQuestionDto();
        CreateOptionInputs = new List<CreateOptionDto> { new CreateOptionDto() };
        NavigationManager.NavigateTo("/questions");
        return Task.CompletedTask;
    }

    private void Back()
    {
        NavigationManager.NavigateTo("/questions");
    }
}

